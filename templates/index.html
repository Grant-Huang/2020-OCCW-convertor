{% extends "base.html" %}

{% block title %}{{ t('home_title') }}{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-file-invoice-dollar me-3 page-icon"></i>
                    {{ t('home_title') }}
                </h1>
                <p class="page-subtitle">{{ t('home_subtitle') }}</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="status-indicator">
                    <i class="fas fa-check-circle me-2"></i>{{ t('system_status_ready') }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- APP图标导航 -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="app-icon-card" onclick="showPdfImportApp()">
                        <div class="app-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="app-title">{{ t('pdf_import_quote') }}</div>
                        <div class="app-description">{{ t('pdf_import_desc') }}</div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="app-icon-card" onclick="showManualCreateApp()">
                        <div class="app-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="app-title">{{ t('manual_create_quote') }}</div>
                        <div class="app-description">{{ t('manual_create_desc') }}</div>
                    </div>
                </div>
            </div>

            <!-- APP内容区域 -->
            <div id="appContent">
                <!-- PDF导入APP -->
                <div id="pdf-import-app" class="app-content" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-pdf me-2"></i>{{ t('upload_pdf_quote') }}
                            </h5>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="showHomePage()">
                                <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_home') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="quotationForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="quotationFile" class="form-label">{{ t('select_file') }}</label>
                                    <input type="file" class="form-control" id="quotationFile" name="file" accept=".pdf" required>
                                    <div class="form-text">{{ t('upload_pdf_desc') }}</div>
                                </div>
                                <button type="submit" class="btn btn-purple">
                                    <i class="fas fa-upload me-1"></i>{{ t('upload_button') }}
                                </button>
                            </form>
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                                <small class="text-muted">{{ t('processing_pdf') }}</small>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- 手动创建报价单APP -->
                <div id="manual-create-app" class="app-content" style="display: none;">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-edit me-2"></i>{{ t('manual_create_quote') }}
                            </h5>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="showHomePage()">
                                <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_home') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 添加产品按钮 -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-purple" onclick="addManualProduct()">
                                    <i class="fas fa-plus me-1"></i>{{ t('add_product') }}
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" onclick="clearManualQuotation()">
                                    <i class="fas fa-trash me-1"></i>{{ t('clear_list') }}
                                </button>
                            </div>

                            <!-- 产品列表表格 -->
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="manualProductsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 8%;">{{ t('sequence_number') }}</th>
                                            <th style="width: 15%;">{{ t('product_type') }}</th>
                                            <th style="width: 15%;">{{ t('product_name') }}</th>
                                            <th style="width: 12%;">{{ t('box_variant') }}</th>
                                            <th style="width: 12%;">{{ t('door_variant') }}</th>
                                            <th style="width: 15%;">SKU</th>
                                            <th style="width: 10%;">{{ t('unit_price') }}</th>
                                            <th style="width: 8%;">{{ t('quantity') }}</th>
                                            <th style="width: 5%;">{{ t('operation') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manualProductsTableBody">
                                        <!-- 动态添加的产品行将在这里显示 -->
                                    </tbody>
                                    <tfoot class="table-info">
                                        <tr>
                                            <td colspan="6" class="text-end"><strong>{{ t('total_price') }}：</strong></td>
                                            <td id="manualTotalPrice" class="fw-bold">$0.00</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- 导出按钮 -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-success" onclick="exportManualQuotation()" id="exportManualBtn" disabled>
                                    <i class="fas fa-download me-1"></i>{{ t('export_quote') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="quotationResult" class="mt-4" style="display: none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-table me-2"></i>{{ t('quote_result') }}
            </h5>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportQuotation('excel')">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportQuotation('csv')">
                    <i class="fas fa-file-csv me-1"></i>CSV
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportQuotation('pdf')">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="exportOCCWQuotation()">
                    <i class="fas fa-file-excel me-1"></i>{{ t('occw_excel') }}
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showPdfText()">
                    <i class="fas fa-eye me-1"></i>{{ t('pdf_text') }}
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="quotationTable">
                    <thead>
                        <tr>
                            <th>{{ t('col_seq') }}</th>
                            <th>{{ t('col_code') }}</th>
                            <th>{{ t('col_qty') }}</th>
                            <th>{{ t('col_color') }}</th>
                            <th>{{ t('col_2020_price') }}</th>
                            <th>{{ t('col_2020_total') }}</th>
                            <th>{{ t('col_occw_sku') }}</th>
                            <th>{{ t('col_occw_price') }}</th>
                            <th>{{ t('col_occw_total') }}</th>
                        </tr>
                    </thead>
                    <tbody id="quotationTableBody">
                    </tbody>
                    <tfoot class="table-info">
                        <tr>
                            <td colspan="5" class="text-end"><strong>{{ t('total_2020') }}：</strong></td>
                            <td id="total2020Price"><strong>$0.00</strong></td>
                            <td class="text-end"><strong>{{ t('total_occw') }}：</strong></td>
                            <td colspan="2" id="totalOCCWPrice"><strong>$0.00</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* APP图标样式 */
.app-icon-card {
    background: linear-gradient(135deg, #714B67 0%, #8B5A8B 100%);
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(113, 75, 103, 0.3);
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.app-icon-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(113, 75, 103, 0.4);
}

.app-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.9;
}

.app-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.app-description {
    font-size: 0.9rem;
    opacity: 0.8;
    line-height: 1.4;
}

.app-content {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 主页欢迎区域 */
.home-welcome {
    text-align: center;
    padding: 2rem 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    margin-bottom: 2rem;
}

.home-welcome h2 {
    color: #714B67;
    margin-bottom: 1rem;
}

.home-welcome p {
    color: #6c757d;
    font-size: 1.1rem;
    margin-bottom: 0;
}
.custom-file-input-container {
    position: relative;
}

.custom-file-input {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.custom-file-input:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.custom-file-input.dragover {
    border-color: #28a745;
    background-color: #d4edda;
}

.file-input-placeholder, .file-input-selected {
    width: 100%;
}

.file-input-selected {
    color: #007bff;
}

.custom-file-input.has-file {
    border-color: #28a745;
    background-color: #d4edda;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentProducts = [];

// APP导航函数
function showPdfImportApp() {
    $('.app-icon-card').hide();
    $('#pdf-import-app').show();
    $('#manual-create-app').hide();
    $('#quotationResult').hide();
}

function showManualCreateApp() {
    $('.app-icon-card').hide();
    $('#pdf-import-app').hide();
    $('#manual-create-app').show();
    $('#quotationResult').hide();
}

function showHomePage() {
    $('.app-icon-card').show();
    $('#pdf-import-app').hide();
    $('#manual-create-app').hide();
    $('#quotationResult').hide();
    
    // 清空文件输入
    $('#quotationFile').val('');
    
    // 隐藏上传进度
    $('#uploadProgress').hide();
}

// 自动语言检测函数
function autoDetectLanguage() {
    // 检查是否已经设置过语言，避免无限循环
    if (sessionStorage.getItem('language_set')) {
        return;
    }
    
    // 1. 检查服务器是否已经检测到语言
    const serverDetectedLanguage = '{{ detected_language if detected_language else "" }}';
    if (serverDetectedLanguage && serverDetectedLanguage !== 'zh') {
        setLanguage(serverDetectedLanguage);
        return;
    }
    
    // 2. 检查浏览器语言
    const browserLanguage = navigator.language || navigator.userLanguage;
    if (browserLanguage) {
        const langCode = browserLanguage.toLowerCase().split('-')[0];
        if (langCode === 'en' || langCode === 'fr') {
            setLanguage(langCode);
            return;
        }
    }
    
    // 3. 检查系统语言（通过navigator.languages）
    if (navigator.languages && navigator.languages.length > 0) {
        for (let lang of navigator.languages) {
            const langCode = lang.toLowerCase().split('-')[0];
            if (langCode === 'en' || langCode === 'fr') {
                setLanguage(langCode);
                return;
            }
        }
    }
    
    // 如果没有检测到需要切换的语言，标记为已处理
    sessionStorage.setItem('language_set', 'true');
}

// 设置语言函数
function setLanguage(langCode) {
    // 标记语言已设置，避免无限循环
    sessionStorage.setItem('language_set', 'true');
    
    // 发送请求到服务器设置语言
    fetch(`/set_language/${langCode}`)
        .then(response => {
            if (response.ok) {
                // 重新加载页面以应用新语言
                window.location.reload();
            }
        })
        .catch(error => {
            console.log('Language detection failed:', error);
        });
}

$(document).ready(function() {
    // 自动语言检测和设置
    autoDetectLanguage();
    
    // 报价单上传处理
    $('#quotationForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const fileInput = $('#quotationFile')[0];
        
        if (!fileInput.files[0]) {
            showAlert('{{ t("no_file_selected") }}', 'warning');
            return;
        }
        
        $('#uploadProgress').show();
        
        $.ajax({
            url: '/upload_quotation',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#uploadProgress').hide();
                if (response.success) {
                    currentProducts = response.products;
                    // 清除旧的比对结果
                    $('#quotationResult .alert').remove();
                    displayQuotation(response.products, response.total_price, response.compare_message, response.compare_result);
                    
                    // 保存原始PDF文本供后续使用
                    window.currentPdfText = response.raw_text;
                    
                    // 显示结果区域
                    $('#quotationResult').show();
                    
                    // 显示成功消息并提示可以查看PDF文本
                    showAlert('报价单解析成功！点击"PDF文本"按钮可查看原始PDF内容', 'success');
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function(xhr) {
                $('#uploadProgress').hide();
                const response = xhr.responseJSON;
                showAlert(response ? response.error : '上传失败，请重试', 'danger');
            }
        });
    });

    // 手动创建报价单处理已整合到下方的专门函数中

});

function displayQuotation(products, totalPrice, compareMessage, compareResult) {
    const tbody = $('#quotationTableBody');
    tbody.empty();
    
    let total2020 = 0;
    let totalOCCW = 0;
    
    products.forEach(function(product) {
        const row = $('<tr>');
        const qty = parseInt(product.qty);
        const unitPrice2020 = parseFloat(product.unit_price);
        const totalPrice2020 = unitPrice2020 * qty;
        
        total2020 += totalPrice2020;
        
        // 基本列
        row.append(`<td>${product.seq_num}</td>`);
        row.append(`<td><code>${product.manuf_code}</code></td>`);
        row.append(`<td>${product.qty}</td>`);
        row.append(`<td>${product.door_color}</td>`);
        row.append(`<td>$${unitPrice2020.toFixed(2)}</td>`);
        row.append(`<td>$${totalPrice2020.toFixed(2)}</td>`);
        
        // OCCW SKU列 - 先添加占位符，后续会根据匹配情况决定显示方式
        const skuCellId = `sku-cell-${product.seq_num}`;
        row.append(`<td id="${skuCellId}" data-original-sku="${product.sku}" data-seq="${product.seq_num}" data-user-code="${product.user_code}">
                        <span class="text-muted">检查中...</span>
                    </td>`);
        
        // OCCW单价和总价列 - 先用0填充，后面会通过AJAX获取
        const occwPriceId = `occw-price-${product.seq_num}`;
        const occwTotalId = `occw-total-${product.seq_num}`;
        row.append(`<td id="${occwPriceId}">$0.00</td>`);
        row.append(`<td id="${occwTotalId}">$0.00</td>`);
        
        tbody.append(row);
    });
    
    $('#total2020Price').html(`<strong>$${total2020.toFixed(2)}</strong>`);
    $('#totalOCCWPrice').html(`<strong>$${totalOCCW.toFixed(2)}</strong>`);
    
    // 检查SKU匹配情况并创建相应的显示元素
    checkAndCreateSKUElements();
    // 比对结果显示
    let compareHtml = '';
    if (compareMessage) {
        let alertType = 'info';
        if (compareResult === true) alertType = 'success';
        else if (compareResult === false) alertType = 'danger';
        compareHtml = `<div class="alert alert-${alertType} mb-2" role="alert">${compareMessage}</div>`;
    }
    $('#quotationResult .card-header').after(compareHtml);
    $('#quotationResult').show();
}

function exportQuotation(format) {
    if (currentProducts.length === 0) {
        showAlert('没有可导出的数据', 'warning');
        return;
    }
    
    const params = new URLSearchParams({
        products: JSON.stringify(currentProducts)
    });
    
    window.open(`/export/${format}?${params.toString()}`, '_blank');
}

function exportOCCWQuotation() {
    if (currentProducts.length === 0) {
        showAlert('没有可导出的数据', 'warning');
        return;
    }
    
    // 收集OCCW报价数据
    const occwData = [];
    currentProducts.forEach(function(product) {
        const seqNum = product.seq_num;
        const skuCell = $(`#sku-cell-${seqNum}`);
        const priceCell = $(`#occw-price-${seqNum}`);
        const totalCell = $(`#occw-total-${seqNum}`);
        
        // 获取当前显示的OCCW SKU
        let occwSku = product.sku; // 默认使用原始SKU
        const selectElement = skuCell.find('.sku-select');
        const inputElement = skuCell.find('input[type="text"]');
        
        if (selectElement.length > 0) {
            occwSku = selectElement.val();
        } else if (inputElement.length > 0) {
            occwSku = inputElement.val();
        } else if (skuCell.find('code').length > 0) {
            occwSku = skuCell.find('code').text();
        }
        
        // 获取价格（去除$符号）
        const unitPrice = parseFloat(priceCell.text().replace('$', '')) || 0;
        const totalPrice = parseFloat(totalCell.text().replace('$', '')) || 0;
        
        occwData.push({
            seq_num: product.seq_num,
            occw_sku: occwSku,
            qty: product.qty,
            unit_price: unitPrice,
            total_price: totalPrice
        });
    });
    
    const params = new URLSearchParams({
        occw_data: JSON.stringify(occwData)
    });
    
    window.open(`/export/occw_excel?${params.toString()}`, '_blank');
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('main').prepend(alertHtml);
    
    // 自动隐藏警告和成功消息
    if (type === 'warning' || type === 'success') {
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
}

function showPdfText() {
    // 优先使用已保存的原始PDF文本
    if (window.currentPdfText) {
        showPdfTextModal(window.currentPdfText);
        return;
    }
    
    // 如果没有保存的文本，则从服务器获取
    const fileInput = $('#quotationFile')[0];
    if (!fileInput.files[0]) {
        showAlert('请先上传PDF文件', 'warning');
        return;
    }
    
    const filename = fileInput.files[0].name;
    
    // 显示加载状态
    showAlert('正在获取PDF文本...', 'info');
    
    $.ajax({
        url: '/get_pdf_text',
        type: 'GET',
        data: { filename: filename },
        success: function(response) {
            if (response.success) {
                showPdfTextModal(response.text);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showAlert(response ? response.error : '获取PDF文本失败', 'danger');
        }
    });
}

function showPdfTextModal(text) {
    // 创建模态框显示PDF文本
    const modalHtml = `
        <div class="modal fade" id="pdfTextModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">PDF原始文本（未处理）</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            这是从PDF中直接提取的原始文本，未进行任何处理。您可以查看文本结构，了解PDF解析的原始内容。
                        </div>
                        <pre style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; background-color: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px;">${text}</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('close') }}</button>
                        <button type="button" class="btn btn-primary" onclick="copyPdfText()">{{ t('copy_text') }}</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除旧的模态框（如果存在）
    $('#pdfTextModal').remove();
    
    // 添加新的模态框并显示
    $('body').append(modalHtml);
    new bootstrap.Modal(document.getElementById('pdfTextModal')).show();
}

function copyPdfText() {
    const textElement = document.querySelector('#pdfTextModal pre');
    const text = textElement.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
        showAlert('PDF文本已复制到剪贴板', 'success');
    }).catch(function() {
        showAlert('复制失败，请手动选择文本复制', 'warning');
    });
}



function saveSkuMapping(originalSku, mappedSku, seqNum) {
    $.ajax({
        url: '/save_sku_mapping',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            original_sku: originalSku,
            mapped_sku: mappedSku
        }),
        success: function(response) {
            if (response.success) {
                // 获取对应产品的数量
                const qtyCell = $(`#sku-cell-${seqNum}`).closest('tr').find('td:nth-child(3)');
                const qty = parseInt(qtyCell.text()) || 1;
                
                const unitPrice = response.occw_price;
                const totalPrice = unitPrice * qty;
                
                // 更新价格显示
                updatePriceDisplay(seqNum, unitPrice);
                
                // 更新SKU单元格显示为映射后的SKU
                const cell = $(`#sku-cell-${seqNum}`);
                cell.html(`<code class="text-primary">${mappedSku}</code> <small class="text-muted">(已映射)</small>`);
                
                updateOCCWTotal();
                showAlert('SKU映射已保存', 'success');
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('保存SKU映射失败', 'danger');
        }
    });
}

function updateOCCWTotal() {
    let totalOCCW = 0;
    $('[id^="occw-total-"]').each(function() {
        const priceText = $(this).text().replace('$', '');
        totalOCCW += parseFloat(priceText) || 0;
    });
    $('#totalOCCWPrice').html(`<strong>$${totalOCCW.toFixed(2)}</strong>`);
}

function checkAndCreateSKUElements() {
    // 防止重复调用
    if (window.checkingSKUs) {
        return;
    }
    window.checkingSKUs = true;
    
    let pendingChecks = 0;
    
    $('[id^="sku-cell-"]').each(function() {
        const cell = $(this);
        const originalSku = cell.data('original-sku');
        const seqNum = cell.data('seq');
        const userCode = cell.data('user-code');
        
        pendingChecks++;
        
        // 首先检查原始SKU是否存在于OCCW价格表中
        $.ajax({
            url: '/get_occw_price',
            type: 'GET',
            data: { sku: originalSku },
            success: function(response) {
                if (response.success && response.price > 0) {
                    // SKU精确匹配，直接显示
                    cell.html(`<code class="text-success">${originalSku}</code>`);
                    updatePriceDisplay(seqNum, response.price);
                } else {
                    // SKU不匹配，创建下拉框或输入框供用户选择
                    createSKUDropdown(cell, originalSku, seqNum, userCode);
                }
            },
            error: function() {
                // 出错时也创建下拉框
                createSKUDropdown(cell, originalSku, seqNum, userCode);
            },
            complete: function() {
                pendingChecks--;
                if (pendingChecks === 0) {
                    updateOCCWTotal();
                    window.checkingSKUs = false;
                }
            }
        });
    });
    
    // 如果没有需要检查的项目，立即解锁
    if (pendingChecks === 0) {
        window.checkingSKUs = false;
    }
}

function createSKUDropdown(cell, originalSku, seqNum, userCode) {
    // 获取包含userCode的SKU列表
    $.ajax({
        url: '/get_occw_skus',
        type: 'GET',
        data: { filter_user_code: userCode },
        success: function(response) {
            if (response.success && response.skus.length > 0) {
                // 有匹配的SKU，创建下拉框
                const selectId = `sku-select-${seqNum}`;
                let selectHtml = `<select class="form-select form-select-sm sku-select" id="${selectId}" data-original-sku="${originalSku}" data-seq="${seqNum}">`;
                selectHtml += `<option value="${originalSku}">${originalSku} (原始)</option>`;
                
                response.skus.forEach(function(sku) {
                    if (sku !== originalSku) {
                        selectHtml += `<option value="${sku}">${sku}</option>`;
                    }
                });
                
                selectHtml += '</select>';
                cell.html(selectHtml);
                
                // 绑定变更事件
                $(`#${selectId}`).on('change', function() {
                    const selectedSku = $(this).val();
                    const originalSku = $(this).data('original-sku');
                    const seqNum = $(this).data('seq');
                    
                    if (selectedSku !== originalSku) {
                        saveSkuMapping(originalSku, selectedSku, seqNum);
                    } else {
                        // 选择了原始SKU，清除映射并更新价格
                        updatePriceForSKU(seqNum, selectedSku);
                    }
                });
                
                // 检查是否有现有映射关系
                checkExistingMapping(originalSku, selectId, seqNum);
            } else {
                // 没有匹配的SKU，提供输入框
                createSKUInput(cell, originalSku, seqNum);
            }
        },
        error: function() {
            // 出错时也提供输入框
            createSKUInput(cell, originalSku, seqNum);
        }
    });
}

function createSKUInput(cell, originalSku, seqNum) {
    const inputId = `sku-input-${seqNum}`;
    const inputHtml = `
        <div class="input-group input-group-sm">
            <input type="text" class="form-control" id="${inputId}" 
                   data-original-sku="${originalSku}" data-seq="${seqNum}"
                   placeholder="输入OCCW SKU" value="${originalSku}">
            <button class="btn btn-outline-primary" type="button" onclick="confirmSKUInput('${seqNum}')">
                <i class="fas fa-check"></i>
            </button>
        </div>
    `;
    cell.html(inputHtml);
    
    // 绑定回车键事件
    $(`#${inputId}`).on('keypress', function(e) {
        if (e.which === 13) { // Enter键
            confirmSKUInput(seqNum);
        }
    });
    
    // 检查是否有现有映射关系
    checkExistingMappingForInput(originalSku, inputId, seqNum);
}

function confirmSKUInput(seqNum) {
    const input = $(`#sku-input-${seqNum}`);
    const newSku = input.val().trim();
    const originalSku = input.data('original-sku');
    
    if (!newSku) {
        showAlert('请输入有效的SKU', 'warning');
        return;
    }
    
    if (newSku !== originalSku) {
        saveSkuMapping(originalSku, newSku, seqNum);
    } else {
        updatePriceForSKU(seqNum, newSku);
    }
}

function checkExistingMapping(originalSku, selectId, seqNum) {
    // 从映射关系中查找是否已有映射
    $.ajax({
        url: '/get_sku_mappings',
        type: 'GET',
        success: function(response) {
            if (response.success && response.mappings[originalSku]) {
                const mappedSku = response.mappings[originalSku];
                $(`#${selectId}`).val(mappedSku);
                updatePriceForSKU(seqNum, mappedSku);
                
                // 如果有映射关系，替换单元格内容为固定的映射SKU显示
                const cell = $(`#sku-cell-${seqNum}`);
                cell.html(`<code class="text-primary">${mappedSku}</code> <small class="text-muted">(已映射)</small>`);
            } else {
                updatePriceForSKU(seqNum, originalSku);
            }
        },
        error: function() {
            updatePriceForSKU(seqNum, originalSku);
        }
    });
}

function checkExistingMappingForInput(originalSku, inputId, seqNum) {
    // 从映射关系中查找是否已有映射
    $.ajax({
        url: '/get_sku_mappings',
        type: 'GET',
        success: function(response) {
            if (response.success && response.mappings[originalSku]) {
                const mappedSku = response.mappings[originalSku];
                $(`#${inputId}`).val(mappedSku);
                updatePriceForSKU(seqNum, mappedSku);
                
                // 如果有映射关系，替换单元格内容为固定的映射SKU显示
                const cell = $(`#sku-cell-${seqNum}`);
                cell.html(`<code class="text-primary">${mappedSku}</code> <small class="text-muted">(已映射)</small>`);
            } else {
                updatePriceForSKU(seqNum, originalSku);
            }
        },
        error: function() {
            updatePriceForSKU(seqNum, originalSku);
        }
    });
}

function updatePriceForSKU(seqNum, sku) {
    $.ajax({
        url: '/get_occw_price',
        type: 'GET',
        data: { sku: sku },
        success: function(response) {
            if (response.success) {
                updatePriceDisplay(seqNum, response.price);
            } else {
                updatePriceDisplay(seqNum, 0);
            }
        },
        error: function() {
            updatePriceDisplay(seqNum, 0);
        }
    });
}

function updatePriceDisplay(seqNum, unitPrice) {
    // 获取数量
    const qtyCell = $(`#sku-cell-${seqNum}`).closest('tr').find('td:nth-child(3)');
    const qty = parseInt(qtyCell.text()) || 1;
    const totalPrice = unitPrice * qty;
    
    const priceCell = $(`#occw-price-${seqNum}`);
    const totalCell = $(`#occw-total-${seqNum}`);
    
    priceCell.html(`$${parseFloat(unitPrice).toFixed(2)}`);
    totalCell.html(`$${totalPrice.toFixed(2)}`);
    
    // 如果价格为0，添加浅红色背景
    if (unitPrice <= 0) {
        priceCell.addClass('table-danger');
        totalCell.addClass('table-danger');
    } else {
        priceCell.removeClass('table-danger');
        totalCell.removeClass('table-danger');
    }
}

// ===== 手动创建报价单相关函数 =====

let manualProductCounter = 1;
let manualProducts = [];

function addManualProduct() {
    // 添加手动产品行
    const tbody = document.getElementById('manualProductsTableBody');
    const rowId = `manual-row-${manualProductCounter}`;
    
    const row = document.createElement('tr');
    row.id = rowId;
    row.innerHTML = `
        <td>${manualProductCounter}</td>
        <td>
                            <select class="form-select form-select-sm" onchange="onCategoryChange(${manualProductCounter})" id="category-${manualProductCounter}">
                    <option value="">{{ t('select_type') }}</option>
                </select>
        </td>
        <td>
            <select class="form-select form-select-sm" onchange="onProductChange(${manualProductCounter})" id="product-${manualProductCounter}" disabled>
                <option value="">{{ t('select_product') }}</option>
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm" onchange="onVariantChange(${manualProductCounter})" id="box-variant-${manualProductCounter}" disabled>
                <option value="">{{ t('select_box_variant') }}</option>
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm" onchange="onVariantChange(${manualProductCounter})" id="door-variant-${manualProductCounter}" disabled>
                <option value="">{{ t('select_door_variant') }}</option>
            </select>
        </td>
        <td>
            <span id="sku-${manualProductCounter}" class="badge bg-secondary">{{ t('not_selected') }}</span>
        </td>
        <td>
            <span id="price-${manualProductCounter}">$0.00</span>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" value="1" min="1" onchange="updateManualTotal()" id="qty-${manualProductCounter}">
        </td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="removeManualProduct(${manualProductCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    // 加载产品类别
    loadProductCategories(manualProductCounter);
    
    manualProductCounter++;
    updateExportButton();
}

function loadProductCategories(rowNum) {
    // 加载产品类别
    $.ajax({
        url: '/get_product_categories',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = document.getElementById(`category-${rowNum}`);
                response.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            }
        },
        error: function() {
            showAlert('加载产品类别失败', 'warning');
        }
    });
}

function onCategoryChange(rowNum) {
    // 类型选择改变时的处理
    const category = document.getElementById(`category-${rowNum}`).value;
    const productSelect = document.getElementById(`product-${rowNum}`);
    const boxVariantSelect = document.getElementById(`box-variant-${rowNum}`);
    const doorVariantSelect = document.getElementById(`door-variant-${rowNum}`);
    
    // 清空后续选择
    productSelect.innerHTML = '<option value="">{{ t("select_product") }}</option>';
    boxVariantSelect.innerHTML = '<option value="">{{ t("select_box_variant") }}</option>';
    doorVariantSelect.innerHTML = '<option value="">{{ t("select_door_variant") }}</option>';
    
    // 重置SKU和价格
    document.getElementById(`sku-${rowNum}`).textContent = '{{ t("not_selected") }}';
    document.getElementById(`sku-${rowNum}`).className = 'badge bg-secondary';
    document.getElementById(`price-${rowNum}`).textContent = '$0.00';
    
    if (category) {
        productSelect.disabled = false;
        
        // 根据类型启用/禁用变体选择
        if (category === 'BOX') {
            boxVariantSelect.disabled = false;
            doorVariantSelect.disabled = false;
        } else if (category === 'Door' || category === 'ENDING PANEL' || category === 'MOLDING' || category === 'TOE KICK' || category === 'FILLER') {
            boxVariantSelect.disabled = true;
            doorVariantSelect.disabled = false;
        } else if (category === 'Assm.组合件') {
            boxVariantSelect.disabled = false;
            doorVariantSelect.disabled = false;
        } else if (category === 'HARDWARE') {
            boxVariantSelect.disabled = true;
            doorVariantSelect.disabled = true;
        }
        
        // 加载产品列表
        loadProductsByCategory(category, rowNum);
    } else {
        productSelect.disabled = true;
        boxVariantSelect.disabled = true;
        doorVariantSelect.disabled = true;
    }
}

function loadProductsByCategory(category, rowNum) {
    // 根据类别加载产品列表
    $.ajax({
        url: '/get_products_by_category',
        type: 'GET',
        data: { category: category },
        success: function(response) {
            if (response.success) {
                const productSelect = document.getElementById(`product-${rowNum}`);
                const boxVariantSelect = document.getElementById(`box-variant-${rowNum}`);
                const doorVariantSelect = document.getElementById(`door-variant-${rowNum}`);
                
                // 填充产品选择
                response.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
                
                // 填充柜身变体选择
                response.box_variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant;
                    option.textContent = variant;
                    boxVariantSelect.appendChild(option);
                });
                
                // 填充门板变体选择
                response.door_variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant;
                    option.textContent = variant;
                    doorVariantSelect.appendChild(option);
                });
            }
        },
        error: function() {
            showAlert('加载产品列表失败', 'warning');
        }
    });
}

function onProductChange(rowNum) {
    // 产品选择改变时的处理
    searchSkuAndPrice(rowNum);
}

function onVariantChange(rowNum) {
    // 变体选择改变时的处理
    searchSkuAndPrice(rowNum);
}

function searchSkuAndPrice(rowNum) {
    // 搜索SKU和价格
    const category = document.getElementById(`category-${rowNum}`).value;
    const product = document.getElementById(`product-${rowNum}`).value;
    const boxVariant = document.getElementById(`box-variant-${rowNum}`).value;
    const doorVariant = document.getElementById(`door-variant-${rowNum}`).value;
    
    if (!category || !product) {
        return;
    }
    
    $.ajax({
        url: '/search_sku_price',
        type: 'GET',
        data: {
            category: category,
            product: product,
            box_variant: boxVariant,
            door_variant: doorVariant
        },
        success: function(response) {
            if (response.success) {
                const skuElement = document.getElementById(`sku-${rowNum}`);
                const priceElement = document.getElementById(`price-${rowNum}`);
                
                if (response.found) {
                    skuElement.textContent = response.sku;
                    skuElement.className = 'badge bg-success';
                    priceElement.textContent = `$${response.price.toFixed(2)}`;
                } else {
                    skuElement.textContent = '{{ t("not_found") }}';
                    skuElement.className = 'badge bg-danger';
                    priceElement.textContent = '$0.00';
                }
                
                updateManualTotal();
            }
        },
        error: function() {
            showAlert('搜索SKU失败', 'warning');
        }
    });
}

function removeManualProduct(rowNum) {
    // 删除产品行
    const row = document.getElementById(`manual-row-${rowNum}`);
    if (row) {
        row.remove();
        updateManualTotal();
        updateExportButton();
    }
}

function updateManualTotal() {
    // 更新合计价格
    let total = 0;
    const tbody = document.getElementById('manualProductsTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const priceText = row.cells[6].textContent;
        const qtyInput = row.cells[7].querySelector('input');
        
        if (priceText && qtyInput) {
            const price = parseFloat(priceText.replace('$', '')) || 0;
            const qty = parseInt(qtyInput.value) || 0;
            total += price * qty;
        }
    }
    
    document.getElementById('manualTotalPrice').textContent = `$${total.toFixed(2)}`;
}

function clearManualQuotation() {
    // 清空手动报价单
    if (confirm('确定要清空所有产品吗？')) {
        document.getElementById('manualProductsTableBody').innerHTML = '';
        manualProductCounter = 1;
        updateManualTotal();
        updateExportButton();
    }
}

function updateExportButton() {
    // 更新导出按钮状态
    const tbody = document.getElementById('manualProductsTableBody');
    const exportBtn = document.getElementById('exportManualBtn');
    
    if (tbody.children.length > 0) {
        exportBtn.disabled = false;
    } else {
        exportBtn.disabled = true;
    }
}

function exportManualQuotation() {
    // 导出手动创建的报价单
    const tbody = document.getElementById('manualProductsTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    if (rows.length === 0) {
        showAlert('没有产品可导出', 'warning');
        return;
    }
    
    // 收集产品数据
    const products = [];
    for (let row of rows) {
        const rowData = {
            seq_num: row.cells[0].textContent,
            category: row.cells[1].querySelector('select').value,
            product: row.cells[2].querySelector('select').value,
            box_variant: row.cells[3].querySelector('select').value,
            door_variant: row.cells[4].querySelector('select').value,
            sku: row.cells[5].textContent,
            price: row.cells[6].textContent,
            qty: row.cells[7].querySelector('input').value
        };
        products.push(rowData);
    }
    
    // 创建Excel文件并下载
    createExcelFromManualData(products);
}

function createExcelFromManualData(products) {
    // 从手动数据创建Excel文件
    // 这里可以使用SheetJS或其他库来创建Excel文件
    // 暂时使用简单的CSV格式
    let csvContent = "序号,类型,产品名称,柜身变体,门板变体,SKU,单价,数量,小计\n";
    
    products.forEach(product => {
        const price = parseFloat(product.price.replace('$', '')) || 0;
        const qty = parseInt(product.qty) || 0;
        const subtotal = price * qty;
        
        csvContent += `${product.seq_num},${product.category},${product.product},${product.box_variant},${product.door_variant},${product.sku},${product.price},${product.qty},$${subtotal.toFixed(2)}\n`;
    });
    
    // 创建下载链接
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `manual_quotation_${new Date().getTime()}.csv`;
    link.click();
}
</script>
{% endblock %} 